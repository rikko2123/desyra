# La CI crea un ambiente di test temporaneo, valida la configurazione,
# avvia lo stack Docker e fallisce immediatamente se qualcosa non Ã¨ corretto.
# Nessun deploy avviene a questo livello

#avvia macchina temporanea 
name: Build and Push Docker Image

on:
  push:
    branches: [ master ]
  pull_request:

#estraggo i metadati dalla repo GIT
jobs:
  integration-test:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout #clono git repo con checkout
        uses: actions/checkout@v4
      # valido env var e secrets
      - name: Validate required env variables
        env:
          DB_HOST: ${{ vars.DATABASE_HOST }}
          DB_USER: ${{ vars.DATABASE_USERNAME }}
          DB_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          DB_PORT: ${{ vars.DATABASE_PORT }}

        # creo script bash che mi valida le env 
        # itero per le env che ho definito nel job
        # con -z al valore della variabile verifico che no sia vuota
        # nel caso blocco flusso esecuzione test
        run: |
          echo "[+] Carico var d'ambiente...."
          for v in DB_HOST DB_USER DB_PASSWORD DB_PORT; do
            if [ -z "${!v}" ]; then
              echo "[+] Variabile ${v} non trovata/non corretta... :("
              exit 1
            fi 
          done 
          echo "[+] Tutte var corrette e settate"

      #una volta validato le env creo file da passare al container
      - name: Create .env file
        env:
          DB_HOST: ${{ vars.DATABASE_HOST }}
          DB_USER: ${{ vars.DATABASE_USERNAME }}
          DB_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          DB_PORT: ${{ vars.DATABASE_PORT }}
        run: |
          cat <<EOF > .env
          DB_HOST=$DB_HOST
          DB_USER=$DB_USER
          DB_PASSWORD=$DB_PASSWORD
          DB_PORT=$DB_PORT
          EOF

      #auth con token docker
      - name: Extract Docker image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ vars.DOCKER_USERNAME }}/my-image
      - name: Log in to Docker Hub #log in a docker hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # AVVIO DOCKER (ambiente di test)
      # controllo se risponde l'endpoint healt, se non 200 exit
      - name: Start containers
        run: |
          set -euo pipefail
          docker compose -f infra/docker-compose.ci.yml up -d --build
          docker compose ps
          sleep 10
          curl -f http://localhost:8000/health
      

